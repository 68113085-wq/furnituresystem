<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Furniture Pro | ระบบสต็อกสินค้า + AI Chatbot + Receipt</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
        .page-section { display: none; }
        .active-section { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-active { background-color: #1e293b !important; color: white !important; border-color: #1e293b !important; transform: scale(1.05); }
        
        /* Admin Sidebar */
        .admin-sidebar { width: 280px; background-color: #111827; color: white; flex-shrink: 0; transition: all 0.3s; }
        .admin-content { flex-grow: 1; background-color: #f3f4f6; overflow-y: auto; height: 100vh; }
        .nav-item { padding: 14px 24px; cursor: pointer; display: flex; items-center; gap: 12px; color: #9ca3af; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background-color: #374151; color: #fff; border-right: 4px solid #6366f1; }
        
        /* Loading & Utils */
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4f46e5; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .out-of-stock { filter: grayscale(100%); opacity: 0.7; pointer-events: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loading" class="fixed inset-0 bg-white/80 z-[100] hidden flex justify-center items-center backdrop-blur-sm">
        <div class="text-center">
            <div class="loader mx-auto mb-2"></div>
            <p class="text-indigo-600 font-bold animate-pulse">กำลังประมวลผล...</p>
        </div>
    </div>

    <div id="customer-view" class="flex flex-col min-h-screen">
        <nav class="bg-white shadow-sm sticky top-0 z-40 border-b border-slate-100">
            <div class="container mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="router('home')">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><i class="fas fa-couch"></i></div>
                    <span class="text-xl font-bold text-indigo-900">Furniture<span class="text-indigo-600">Pro</span></span>
                </div>
                <div class="hidden md:flex items-center gap-6 font-medium text-slate-600">
                    <a onclick="router('home')" class="cursor-pointer hover:text-indigo-600 transition">สินค้า</a>
                    <a onclick="checkAuth('orders')" class="cursor-pointer hover:text-indigo-600 transition">สถานะคำสั่งซื้อ</a>
                    <div class="relative cursor-pointer group" onclick="router('cart')">
                        <div class="p-2 rounded-full hover:bg-slate-100 transition"><i class="fas fa-shopping-bag text-xl text-slate-700 group-hover:text-indigo-600"></i></div>
                        <span id="cart-badge" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm border-2 border-white">0</span>
                    </div>
                    <div id="auth-buttons" class="flex gap-2">
                        <button onclick="router('login')" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-100 transition font-bold text-sm">เข้าสู่ระบบ</button>
                    </div>
                    <div id="user-info" class="hidden flex items-center gap-3 pl-4 border-l border-slate-200">
                        <div class="text-right"><div id="user-name" class="text-sm font-bold text-slate-800">User</div><div class="text-xs text-slate-400 cursor-pointer hover:text-red-500" onclick="logout()">ออกจากระบบ</div></div>
                        <button onclick="switchToAdmin()" id="btn-go-admin" class="hidden bg-indigo-600 text-white text-xs px-3 py-2 rounded-lg shadow hover:bg-indigo-700 transition flex items-center gap-1"><i class="fas fa-cogs"></i> หลังบ้าน</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="container mx-auto px-4 py-8 flex-grow">
            <section id="page-home" class="page-section active-section">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 md:p-12 text-white mb-10 shadow-lg relative overflow-hidden">
                    <div class="relative z-10 max-w-2xl"><h1 class="text-3xl md:text-5xl font-bold mb-4">แต่งบ้านในฝัน</h1><p class="text-indigo-100 mb-6">เฟอร์นิเจอร์คุณภาพพรีเมียม พร้อมส่งถึงหน้าบ้าน</p></div>
                    <i class="fas fa-chair absolute -bottom-10 -right-10 text-[15rem] opacity-10 rotate-12"></i>
                </div>
                
                <div class="flex justify-start md:justify-center gap-3 mb-8 overflow-x-auto pb-2 no-scrollbar">
                    <button id="btn-filter-all" onclick="filterProducts('all')" class="filter-btn px-6 py-2 rounded-full bg-slate-800 text-white shadow-lg transition transform hover:scale-105 whitespace-nowrap">ทั้งหมด</button>
                    <button id="btn-filter-sofa" onclick="filterProducts('Sofa')" class="filter-btn px-6 py-2 rounded-full bg-white text-slate-600 border hover:border-indigo-500 transition whitespace-nowrap">โซฟา</button>
                    <button id="btn-filter-table" onclick="filterProducts('Table')" class="filter-btn px-6 py-2 rounded-full bg-white text-slate-600 border hover:border-indigo-500 transition whitespace-nowrap">โต๊ะ/เก้าอี้</button>
                    <button id="btn-filter-bed" onclick="filterProducts('Bed')" class="filter-btn px-6 py-2 rounded-full bg-white text-slate-600 border hover:border-indigo-500 transition whitespace-nowrap">เตียงนอน</button>
                    <button id="btn-filter-cabinet" onclick="filterProducts('Cabinet')" class="filter-btn px-6 py-2 rounded-full bg-white text-slate-600 border hover:border-indigo-500 transition whitespace-nowrap">ตู้/ชั้นวาง</button>
                    <button id="btn-filter-lamp" onclick="filterProducts('Lamp')" class="filter-btn px-6 py-2 rounded-full bg-white text-slate-600 border hover:border-indigo-500 transition whitespace-nowrap">โคมไฟ</button>
                    <button id="btn-filter-decor" onclick="filterProducts('Decor')" class="filter-btn px-6 py-2 rounded-full bg-white text-slate-600 border hover:border-indigo-500 transition whitespace-nowrap">ของตกแต่ง</button>
                </div>

                <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </section>

            <section id="page-cart" class="page-section max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-shopping-cart text-indigo-600"></i> ตะกร้าสินค้า</h2>
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div id="cart-items-container" class="p-6 space-y-4 min-h-[200px]"></div>
                    <div class="bg-slate-50 p-6 border-t flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="text-lg font-bold text-slate-700">รวม: <span id="cart-total" class="text-2xl text-indigo-600">0</span> บาท</div>
                        <button onclick="goToCheckout()" id="checkout-btn" class="w-full md:w-auto bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold shadow">ชำระเงิน</button>
                    </div>
                </div>
            </section>

            <section id="page-checkout" class="page-section max-w-3xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-100">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-4 text-slate-800">ยืนยันการสั่งซื้อ</h2>
                    <form onsubmit="submitOrder(event)">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <label class="block font-bold mb-2 text-slate-700">ที่อยู่จัดส่ง</label>
                                <textarea id="shipping-address" rows="5" class="w-full border border-slate-300 p-3 rounded-lg bg-slate-50" required></textarea>
                            </div>
                            <div>
                                <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 mb-6">
                                    <h3 class="font-bold text-indigo-900">โอนเงินผ่านธนาคาร</h3>
                                    <p class="text-sm text-slate-600 mt-2">ธ.กสิกรไทย: <strong>012-3-45678-9</strong></p>
                                    <div class="mt-4 pt-4 border-t border-indigo-200 flex justify-between items-end">
                                        <span class="text-sm text-indigo-800">ยอดชำระ</span>
                                        <span class="text-xl font-bold text-indigo-700"><span id="checkout-amount">0</span> ฿</span>
                                    </div>
                                </div>
                                <label class="block font-bold mb-2 text-slate-700">สลิปโอนเงิน</label>
                                <input type="file" id="payment-slip" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700" required>
                            </div>
                        </div>
                        <button type="submit" class="w-full mt-8 bg-green-600 text-white py-4 rounded-lg font-bold hover:bg-green-700 text-lg shadow-lg transition">ยืนยันคำสั่งซื้อ</button>
                    </form>
                </div>
            </section>

            <section id="page-orders" class="page-section max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold mb-6">ประวัติการสั่งซื้อ</h2>
                <div id="my-orders-list" class="space-y-4"></div>
            </section>

            <section id="page-login" class="page-section max-w-md mx-auto mt-10">
                <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                    <h2 class="text-3xl font-bold text-indigo-900 mb-6 text-center" id="auth-title">เข้าสู่ระบบ</h2>
                    <form onsubmit="handleAuth(event)">
                        <div id="field-name" class="mb-4 hidden"><input type="text" id="auth-name" placeholder="ชื่อ-นามสกุล" class="w-full border p-3 rounded-lg"></div>
                        <div class="mb-4"><input type="email" id="auth-email" placeholder="อีเมล" class="w-full border p-3 rounded-lg" required></div>
                        <div class="mb-6"><input type="password" id="auth-pass" placeholder="รหัสผ่าน" class="w-full border p-3 rounded-lg" required></div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-lg">ยืนยัน</button>
                    </form>
                    <div class="mt-6 text-center pt-4 border-t"><button onclick="toggleAuthMode()" class="text-indigo-600 font-bold hover:underline text-sm">สมัครสมาชิกใหม่</button></div>
                </div>
            </section>
        </main>
    </div>

    <div id="admin-view" class="flex hidden h-screen">
        <aside class="admin-sidebar flex flex-col shadow-xl">
            <div class="p-6 text-xl font-bold border-b border-gray-800 flex items-center gap-2"><i class="fas fa-shield-alt text-indigo-500"></i> Admin Panel</div>
            <nav class="flex-grow mt-4 space-y-1 px-2">
                <div id="nav-dashboard" class="nav-item rounded-lg active" onclick="adminRouter('dashboard')">ภาพรวม</div>
                <div id="nav-products" class="nav-item rounded-lg" onclick="adminRouter('products')">สินค้า</div>
                <div id="nav-orders" class="nav-item rounded-lg" onclick="adminRouter('orders')">คำสั่งซื้อ</div>
            </nav>
            <div class="p-4 border-t border-gray-800"><button onclick="exitAdmin()" class="w-full py-2 bg-gray-800 text-gray-300 rounded-lg">กลับหน้าร้าน</button></div>
        </aside>
        
        <div class="admin-content p-8">
            <div id="admin-dashboard" class="admin-page">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Dashboard</h2>
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fas fa-file-excel"></i> ส่งออก Excel (ทำบัญชี)
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                        <div class="text-slate-500 text-sm mb-1">ยอดขายวันนี้</div>
                        <div class="text-3xl font-bold text-indigo-700" id="report-daily">0 ฿</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <div class="text-slate-500 text-sm mb-1">ยอดขายสัปดาห์นี้</div>
                        <div class="text-3xl font-bold text-purple-700" id="report-weekly">0 ฿</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                        <div class="text-slate-500 text-sm mb-1">ยอดขายเดือนนี้</div>
                        <div class="text-3xl font-bold text-orange-700" id="report-monthly">0 ฿</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="font-bold mb-4 text-slate-700"><i class="fas fa-chart-bar text-indigo-500"></i> สินค้าขายดี 5 อันดับแรก</h3>
                        <canvas id="bestSellerChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                         <h3 class="font-bold mb-4 text-slate-700"><i class="fas fa-chart-line text-green-500"></i> ยอดขาย 7 วันย้อนหลัง</h3>
                         <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="admin-products" class="admin-page hidden">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">สินค้าในสต็อก</h2><button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> เพิ่มสินค้า</button></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-xs uppercase font-bold text-slate-500">
                            <tr>
                                <th class="p-4">รูป</th>
                                <th class="p-4">ชื่อสินค้า</th>
                                <th class="p-4">หมวดหมู่</th>
                                <th class="p-4">คงเหลือ</th>
                                <th class="p-4">ราคา</th>
                                <th class="p-4 text-right">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-table" class="divide-y text-sm"></tbody>
                    </table>
                </div>
            </div>

            <div id="admin-orders" class="admin-page hidden">
                <h2 class="text-2xl font-bold mb-6">คำสั่งซื้อ</h2>
                <div class="flex gap-2 mb-6"><button onclick="filterAdminOrders('all')" class="px-4 py-2 rounded bg-white border">ทั้งหมด</button><button onclick="filterAdminOrders('Pending')" class="px-4 py-2 rounded bg-yellow-50 border border-yellow-200 text-yellow-700">รอตรวจสอบ</button></div>
                <div id="admin-order-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="fixed inset-0 bg-black/60 hidden flex justify-center items-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-2xl w-full max-w-lg shadow-2xl">
            <h3 class="text-2xl font-bold mb-6" id="modal-title">จัดการสินค้า</h3>
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="edit-id">
                <div class="mb-4"><label class="block font-bold mb-1">ชื่อสินค้า</label><input type="text" id="edit-name" class="w-full border p-2 rounded" required></div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block font-bold mb-1">หมวดหมู่</label>
                        <select id="edit-cat" class="w-full border p-2 rounded">
                            <option value="Sofa">โซฟา</option>
                            <option value="Table">โต๊ะ/เก้าอี้</option>
                            <option value="Bed">เตียงนอน</option>
                            <option value="Cabinet">ตู้/ชั้นวาง</option>
                            <option value="Lamp">โคมไฟ</option>
                            <option value="Decor">ของตกแต่ง</option>
                        </select>
                    </div>
                    <div><label class="block font-bold mb-1">จำนวนสต็อก</label><input type="number" id="edit-stock" class="w-full border p-2 rounded" min="0" required></div>
                </div>
                <div class="mb-4"><label class="block font-bold mb-1">ราคา (บาท)</label><input type="number" id="edit-price" class="w-full border p-2 rounded" required></div>
                <div class="mb-6">
                    <label class="block font-bold mb-1">รูปภาพ</label>
                    <input type="file" id="edit-file" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 mb-2">
                    <input type="text" id="edit-img-url" placeholder="หรือ URL รูปภาพ" class="w-full border p-2 rounded text-sm">
                </div>
                <div class="flex justify-end gap-3"><button type="button" onclick="document.getElementById('product-modal').classList.add('hidden')" class="px-4 py-2 text-slate-600">ยกเลิก</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded font-bold">บันทึก</button></div>
            </form>
        </div>
    </div>

    <div id="image-modal" class="fixed inset-0 bg-black/90 hidden flex justify-center items-center z-[70] p-4" onclick="this.classList.add('hidden')">
        <img id="preview-img" src="" class="max-w-full max-h-full rounded shadow-2xl object-contain">
    </div>

    <div id="order-detail-modal" class="fixed inset-0 bg-black/60 hidden flex justify-center items-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-indigo-900"><i class="fas fa-file-invoice"></i> รายละเอียดคำสั่งซื้อ</h3>
                <button onclick="document.getElementById('order-detail-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto" id="order-detail-content">
                </div>
            <div class="p-4 border-t bg-slate-50 text-right rounded-b-2xl">
                <button onclick="document.getElementById('order-detail-modal').classList.add('hidden')" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-bold">ปิดหน้าต่าง</button>
            </div>
        </div>
    </div>

    <div id="receipt-modal" class="fixed inset-0 bg-black/80 hidden flex justify-center items-center z-[100] backdrop-blur-sm p-4 overflow-y-auto">
        <div class="flex flex-col gap-4 w-full max-w-md">
            
            <div id="receipt-capture-area" class="bg-white p-8 rounded-xl shadow-2xl relative overflow-hidden text-slate-800">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                <i class="fas fa-file-invoice-dollar absolute -bottom-10 -right-10 text-[10rem] opacity-5 text-indigo-600 rotate-12 pointer-events-none"></i>
                
                <div class="text-center border-b-2 border-dashed border-slate-200 pb-6 mb-6">
                    <div class="inline-flex items-center justify-center w-12 h-12 bg-indigo-600 text-white rounded-lg mb-2 shadow-sm">
                        <i class="fas fa-couch text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-indigo-900 tracking-wide">Furniture Pro</h2>
                    <p class="text-xs text-slate-500 mt-1 uppercase tracking-widest">Receipt / ใบเสร็จรับเงิน</p>
                    
                    <div class="mt-4 flex justify-between text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100">
                        <div class="text-left">
                            <p>วันที่: <span id="rcp-date" class="font-bold text-slate-800"></span></p>
                            <p>Order No: <span id="rcp-no" class="font-bold text-indigo-600"></span></p>
                        </div>
                        <div class="text-right">
                             <p>เวลา: <span id="rcp-time" class="font-bold text-slate-800"></span></p>
                        </div>
                    </div>
                </div>

                <div class="mb-6 text-sm">
                    <p class="text-xs text-slate-400 mb-1">ลูกค้า (Customer):</p>
                    <p id="rcp-name" class="font-bold text-slate-800 text-lg"></p>
                    <p id="rcp-address" class="text-xs text-slate-500 mt-1 leading-relaxed pl-2 border-l-2 border-indigo-200"></p>
                </div>

                <table class="w-full text-sm mb-6">
                    <thead>
                        <tr class="border-b border-slate-200 text-xs text-slate-500 uppercase">
                            <th class="text-left py-2 font-semibold">รายการ</th>
                            <th class="text-right py-2 font-semibold">รวม</th>
                        </tr>
                    </thead>
                    <tbody id="rcp-items" class="divide-y divide-slate-100">
                        </tbody>
                </table>

                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-slate-600 font-medium">ยอดรวมสุทธิ</span>
                        <span id="rcp-total" class="text-xl font-bold text-indigo-700"></span>
                    </div>
                    <div class="text-center mt-3 pt-3 border-t border-indigo-200/50">
                        <div class="inline-block px-3 py-1 border-2 border-green-500 text-green-600 text-[10px] font-bold uppercase rounded tracking-widest transform -rotate-2">
                            PAID / ชำระแล้ว
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8 text-[10px] text-slate-400">
                    <p>ขอบคุณที่อุดหนุน Furniture Pro</p>
                    <p>หากสินค้ามีปัญหา กรุณาติดต่อภายใน 7 วัน</p>
                    <p class="mt-1 font-mono">www.furniturepro.com</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="downloadReceipt()" class="bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2 active:scale-95">
                    <i class="fas fa-download"></i> บันทึกรูปภาพ
                </button>
                <button onclick="closeReceipt()" class="bg-slate-700 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition active:scale-95">
                    ปิดหน้าต่าง
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, setDoc, getDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD9R3ThthqUyUKCeI8Z1RnabV2G4jaG0sA",
          authDomain: "ferni-34e42.firebaseapp.com",
          projectId: "ferni-34e42",
          storageBucket: "ferni-34e42.firebasestorage.app",
          messagingSenderId: "271376472380",
          appId: "1:271376472380:web:921635446856592176e639",
          measurementId: "G-RCR11R4S1M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let userRole = 'customer';
        let products = [];
        let cart = JSON.parse(localStorage.getItem('furni_cart')) || [];
        let orders = []; 
        let isLoginMode = true;
        
        let chartBestSeller = null;
        let chartSalesTrend = null;

        const STATUS_MAP = {
            'Pending': { label: 'รอตรวจสอบ', color: 'bg-yellow-50 text-yellow-700 border-yellow-200' },
            'Confirmed': { label: 'ยืนยันออเดอร์', color: 'bg-indigo-50 text-indigo-700 border-indigo-200' },
            'Preparing': { label: 'กำลังจัดเตรียมพัสดุ', color: 'bg-blue-50 text-blue-700 border-blue-200' },
            'Packed': { label: 'จัดเตรียมพัสดุแล้ว', color: 'bg-purple-50 text-purple-700 border-purple-200' },
            'CarrierIncoming': { label: 'ขนส่งกำลังเข้ามารับ', color: 'bg-orange-50 text-orange-700 border-orange-200' },
            'Shipped': { label: 'ขนส่งรับพัสดุแล้ว', color: 'bg-green-50 text-green-700 border-green-200' },
            'Cancelled': { label: 'ยกเลิก', color: 'bg-red-50 text-red-700 border-red-200' }
        };

        const el = (id) => document.getElementById(id);
        const formatMoney = (n) => Number(n).toLocaleString() + ' ฿';

        const showLoading = (show) => {
            const l = el('loading');
            if(show) l.classList.remove('hidden');
            else l.classList.add('hidden');
        };

        // ================= Global Helpers =================
        window.openSlip = (url) => {
            if(!url || url.includes('via.placeholder')) { alert("ไม่มีสลิป"); return; }
            el('preview-img').src = url;
            el('image-modal').classList.remove('hidden');
        }

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 500; 
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        const init = async () => {
            showLoading(true);
            try { await fetchProducts(); filterProducts('all'); updateCartDisplay(); } 
            catch (e) { console.error(e); } 
            finally { showLoading(false); }
        }

        // ================= Auth =================
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        userRole = userDoc.data().role || 'customer';
                        el('user-name').innerText = userDoc.data().name;
                    }
                } catch (e) {}
                el('auth-buttons').classList.add('hidden');
                el('user-info').classList.remove('hidden');
                el('btn-go-admin').classList.toggle('hidden', userRole !== 'admin');
                router('home');
            } else {
                userRole = 'customer';
                el('auth-buttons').classList.remove('hidden');
                el('user-info').classList.add('hidden');
                el('btn-go-admin').classList.add('hidden');
            }
        });

        window.handleAuth = async (e) => {
            e.preventDefault();
            showLoading(true);
            try {
                const email = el('auth-email').value;
                const pass = el('auth-pass').value;
                if (isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
                else {
                    const name = el('auth-name').value;
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    await setDoc(doc(db, "users", cred.user.uid), { name, email, role: 'customer', createdAt: new Date() });
                }
            } catch (err) { alert(err.message); } 
            finally { showLoading(false); }
        }

        window.toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            el('auth-title').innerText = isLoginMode ? "เข้าสู่ระบบ" : "สมัครสมาชิก";
            el('field-name').classList.toggle('hidden', isLoginMode);
        }
        window.logout = () => { if(confirm('ออกจากระบบ?')) signOut(auth); }
        
        window.router = (page) => {
            el('customer-view').classList.remove('hidden');
            el('admin-view').classList.add('hidden');
            document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active-section'));
            const target = el(`page-${page}`);
            if(target) target.classList.add('active-section');
            if(page === 'cart') renderCart();
            if(page === 'orders') fetchMyOrders();
        }
        window.checkAuth = (page) => currentUser ? router(page) : (alert("กรุณาเข้าสู่ระบบ"), router('login'));

        // ================= Products & Cart =================
        const fetchProducts = async () => {
            const snap = await getDocs(collection(db, "products"));
            products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            window.products = products;
        }

        window.filterProducts = (cat) => {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('btn-active');
                btn.classList.add('bg-white', 'text-slate-600');
                btn.classList.remove('bg-slate-800', 'text-white');
            });

            let activeBtnId = 'btn-filter-all';
            if (cat === 'Sofa') activeBtnId = 'btn-filter-sofa';
            if (cat === 'Table') activeBtnId = 'btn-filter-table';
            if (cat === 'Bed') activeBtnId = 'btn-filter-bed';
            if (cat === 'Cabinet') activeBtnId = 'btn-filter-cabinet';
            if (cat === 'Lamp') activeBtnId = 'btn-filter-lamp';
            if (cat === 'Decor') activeBtnId = 'btn-filter-decor';
            
            const activeBtn = el(activeBtnId);
            if(activeBtn) {
                activeBtn.classList.remove('bg-white', 'text-slate-600');
                activeBtn.classList.add('btn-active'); 
            }
            renderProducts(cat);
        }

        window.renderProducts = (filter = 'all') => {
            const grid = el('product-grid');
            grid.innerHTML = '';
            const list = filter === 'all' ? products : products.filter(p => p.category === filter);
            if(list.length === 0) { grid.innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">ไม่พบสินค้าในหมวดนี้</div>'; return; }
            
            list.forEach(p => {
                const stock = p.stock || 0;
                const isOutOfStock = stock <= 0;
                const btnHtml = isOutOfStock 
                    ? `<span class="text-red-500 text-xs font-bold bg-red-50 px-2 py-1 rounded">สินค้าหมด</span>` 
                    : `<button onclick="addToCart('${p.id}')" class="bg-indigo-50 text-indigo-600 w-8 h-8 rounded-full hover:bg-indigo-600 hover:text-white transition"><i class="fas fa-plus"></i></button>`;
                
                grid.innerHTML += `
                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col ${isOutOfStock ? 'out-of-stock' : ''}">
                        <div class="h-48 bg-gray-100 relative">
                            <img src="${p.imageUrl}" class="w-full h-full object-cover">
                            <div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">เหลือ ${stock}</div>
                        </div>
                        <div class="p-4 flex-grow flex flex-col justify-between">
                            <div>
                                <span class="text-[10px] uppercase tracking-wide text-slate-400 font-bold">${p.category}</span>
                                <h3 class="font-bold line-clamp-1 text-slate-800">${p.name}</h3>
                            </div>
                            <div class="flex justify-between items-end mt-2">
                                <span class="text-indigo-600 font-bold">${formatMoney(p.price)}</span>
                                ${btnHtml}
                            </div>
                        </div>
                    </div>`;
            });
        }

        window.addToCart = (id) => {
            const p = products.find(x => x.id === id);
            if((p.stock || 0) <= 0) { alert("สินค้าหมด!"); return; }
            const existing = cart.find(x => x.id === id);
            if(existing && existing.qty >= p.stock) { alert("สินค้าเหลือแค่นี้ครับ"); return; }
            if(existing) existing.qty++; else cart.push({...p, qty: 1});
            updateCartDisplay();
        }

        window.removeFromCart = (index) => {
            if(confirm("ต้องการลบสินค้านี้ออกจากตะกร้า?")) {
                cart.splice(index, 1);
                updateCartDisplay();
                renderCart();
            }
        }

        const updateCartDisplay = () => { localStorage.setItem('furni_cart', JSON.stringify(cart)); el('cart-badge').innerText = cart.reduce((a,b)=>a+b.qty, 0); }
        
        window.renderCart = () => {
            const con = el('cart-items-container');
            con.innerHTML = '';
            let total = 0;
            if(cart.length === 0) { con.innerHTML = `<div class="text-center py-8 text-slate-400">ว่างเปล่า</div>`; el('checkout-btn').disabled = true; } 
            else {
                el('checkout-btn').disabled = false;
                cart.forEach((item, i) => {
                    total += item.price * item.qty;
                    con.innerHTML += `
                        <div class="flex items-center gap-4 border-b pb-4 last:border-0">
                            <img src="${item.imageUrl}" class="w-16 h-16 object-cover rounded bg-slate-100">
                            <div class="flex-grow"><h4 class="font-bold text-sm">${item.name}</h4><div class="text-xs text-slate-500">${formatMoney(item.price)} x ${item.qty}</div></div>
                            <div class="text-right">
                                <div class="font-bold text-indigo-600 text-sm">${formatMoney(item.price * item.qty)}</div>
                                <button onclick="removeFromCart(${i})" class="text-xs text-red-400 hover:underline cursor-pointer">ลบ</button>
                            </div>
                        </div>`;
                });
            }
            el('cart-total').innerText = total.toLocaleString();
        }
        window.goToCheckout = () => { if(!currentUser) return checkAuth('cart'); el('checkout-amount').innerText = el('cart-total').innerText; router('checkout'); }

        // ================= Updated Submit Order (with Receipt) =================
        window.submitOrder = async (e) => {
            e.preventDefault();
            showLoading(true);
            try {
                if(!currentUser) throw new Error("กรุณาเข้าสู่ระบบ");
                const addr = el('shipping-address').value;
                const file = el('payment-slip').files[0];
                
                let url = "https://via.placeholder.com/300?text=No+Slip";
                if (file) url = await compressImage(file);
                else throw new Error("กรุณาแนบสลิป");

                // Prepare Data
                const orderData = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || "User",
                    items: [...cart], // Copy current cart
                    total: cart.reduce((a,b)=>a+(b.price*b.qty),0),
                    address: addr,
                    slipUrl: url, 
                    status: 'Pending',
                    createdAt: new Date(),
                    orderNo: 'ORD-' + Date.now().toString().substr(-6)
                };

                await addDoc(collection(db, "orders"), orderData);

                // Update Stock
                for (const item of cart) {
                    const productRef = doc(db, "products", item.id);
                    await updateDoc(productRef, { stock: increment(-item.qty) });
                }

                // Clear Cart
                cart = []; 
                updateCartDisplay();
                await fetchProducts(); 
                
                showLoading(false);
                
                // Show Receipt instead of alert
                showReceiptModal(orderData);

            } catch (err) { console.error(err); alert("Error: " + err.message); showLoading(false); }
        }

        // --- Receipt Helpers ---
        window.showReceiptModal = (order) => {
            const d = order.createdAt;
            el('rcp-date').innerText = d.toLocaleDateString('th-TH');
            el('rcp-time').innerText = d.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
            el('rcp-no').innerText = order.orderNo;
            el('rcp-name').innerText = order.userName;
            el('rcp-address').innerText = order.address || "-";
            
            const tbody = el('rcp-items');
            tbody.innerHTML = '';
            order.items.forEach(item => {
                tbody.innerHTML += `
                    <tr class="text-slate-700">
                        <td class="py-3">
                            <div class="font-bold text-sm">${item.name}</div>
                            <div class="text-[10px] text-slate-400">จำนวน ${item.qty} x ${Number(item.price).toLocaleString()}</div>
                        </td>
                        <td class="text-right py-3 font-mono font-medium align-top">
                            ${Number(item.price * item.qty).toLocaleString()}
                        </td>
                    </tr>
                `;
            });
            
            el('rcp-total').innerText = formatMoney(order.total);
            el('receipt-modal').classList.remove('hidden');
        }

        window.downloadReceipt = () => {
            const captureArea = el('receipt-capture-area');
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            html2canvas(captureArea, { scale: 2, backgroundColor: "#ffffff", useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Receipt_${el('rcp-no').innerText}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }).catch(err => {
                alert("Error: " + err);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        window.closeReceipt = () => {
            el('receipt-modal').classList.add('hidden');
            router('orders');
        }

        window.fetchMyOrders = async () => {
            if(!currentUser) return;
            const list = el('my-orders-list');
            list.innerHTML = '<p class="text-center text-slate-400">กำลังโหลด...</p>';
            try {
                const q = query(collection(db, "orders"), where("userId", "==", currentUser.uid));
                onSnapshot(q, (snap) => {
                    list.innerHTML = '';
                    if(snap.empty) { list.innerHTML = '<div class="text-center py-8 border-2 border-dashed rounded">ไม่มีรายการ</div>'; return; }
                    
                    const myOrders = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => b.createdAt - a.createdAt);
                    
                    myOrders.forEach(o => {
                        const date = o.createdAt?.toDate ? o.createdAt.toDate().toLocaleDateString('th-TH') : '-';
                        const stInfo = STATUS_MAP[o.status] || { label: o.status, color: 'bg-gray-100 text-gray-600' };
                        let trackingHtml = '';
                        if (o.trackingNumber) {
                            trackingHtml = `<div class="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center gap-3"><i class="fas fa-shipping-fast text-indigo-600 text-xl"></i><div><div class="text-[10px] text-slate-500 uppercase font-bold">เลขพัสดุ (Tracking No.)</div><div class="text-lg font-mono font-bold text-slate-800 select-all">${o.trackingNumber}</div></div></div>`;
                        }

                        list.innerHTML += `
                            <div class="bg-white p-5 rounded-xl border mb-4 shadow-sm hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-3 border-b pb-3 border-slate-100">
                                    <div><div class="font-bold text-lg text-slate-800">#${o.orderNo}</div><div class="text-xs text-slate-400"><i class="far fa-calendar-alt"></i> ${date}</div></div>
                                    <span class="text-xs px-3 py-1.5 rounded-full font-bold border ${stInfo.color}">${stInfo.label}</span>
                                </div>
                                <div class="flex justify-between items-center mb-2"><div class="text-sm text-slate-600">ยอดสุทธิ</div><div class="font-bold text-indigo-600 text-xl">${formatMoney(o.total)}</div></div>
                                <div class="flex items-center justify-between mt-2"><button onclick="openSlip('${o.slipUrl}')" class="text-sm text-slate-500 underline hover:text-indigo-600 flex items-center gap-1"><i class="fas fa-receipt"></i> ดูสลิปโอนเงิน</button></div>
                                ${trackingHtml}
                            </div>`;
                    });
                });
            } catch(e) { console.error(e); list.innerHTML = "Error loading."; }
        }

        // ================= Admin =================
        window.switchToAdmin = () => { if(userRole==='admin'){ el('customer-view').classList.add('hidden'); el('admin-view').classList.remove('hidden'); adminRouter('dashboard'); } }
        window.exitAdmin = () => { el('admin-view').classList.add('hidden'); el('customer-view').classList.remove('hidden'); }
        
        window.adminRouter = (page) => {
            document.querySelectorAll('.admin-page').forEach(e => e.classList.add('hidden'));
            el(`admin-${page}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            const activeNav = el(`nav-${page}`);
            if(activeNav) activeNav.classList.add('active');
            if(page==='products') renderAdminProducts();
            if(page==='orders') fetchAdminOrders();
            if(page==='dashboard') { fetchAdminOrders(); renderAdminDashboard(); }
        }

        window.renderAdminDashboard = () => {
            setTimeout(calculateDashboardStats, 500); 
        }

        function calculateDashboardStats() {
            if(!orders || orders.length === 0) return;

            const today = new Date();
            today.setHours(0,0,0,0);
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            let salesDay = 0, salesWeek = 0, salesMonth = 0;
            let productSales = {}; 
            let dateSales = {}; 

            for(let i=6; i>=0; i--) {
                let d = new Date(today);
                d.setDate(today.getDate() - i);
                dateSales[d.toLocaleDateString('th-TH')] = 0;
            }

            orders.forEach(o => {
                if(o.status === 'Cancelled') return; 
                const d = o.createdAt.toDate();
                const amount = o.total;

                if(d >= today) salesDay += amount;
                if(d >= weekAgo) salesWeek += amount;
                if(d >= monthStart) salesMonth += amount;

                if(d >= weekAgo) {
                    const dateKey = d.toLocaleDateString('th-TH');
                    if(dateSales[dateKey] !== undefined) dateSales[dateKey] += amount;
                }

                if(o.items) {
                    o.items.forEach(item => {
                        if(!productSales[item.name]) productSales[item.name] = 0;
                        productSales[item.name] += item.qty;
                    });
                }
            });

            el('report-daily').innerText = formatMoney(salesDay);
            el('report-weekly').innerText = formatMoney(salesWeek);
            el('report-monthly').innerText = formatMoney(salesMonth);

            const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]).slice(0, 5);
            renderBestSellerChart(sortedProducts);
            renderSalesTrendChart(dateSales);
        }

        function renderBestSellerChart(data) {
            const ctx = document.getElementById('bestSellerChart').getContext('2d');
            if(chartBestSeller) chartBestSeller.destroy();
            
            chartBestSeller = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(x => x[0]),
                    datasets: [{
                        label: 'จำนวนที่ขายได้ (ชิ้น)',
                        data: data.map(x => x[1]),
                        backgroundColor: '#6366f1',
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function renderSalesTrendChart(dataObj) {
            const ctx = document.getElementById('salesTrendChart').getContext('2d');
            if(chartSalesTrend) chartSalesTrend.destroy();

            chartSalesTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{
                        label: 'ยอดขาย (บาท)',
                        data: Object.values(dataObj),
                        borderColor: '#10b981',
                        backgroundColor: '#10b98120',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });
        }

        window.exportToExcel = () => {
            if(!orders || orders.length === 0) { alert("ไม่มีข้อมูลให้ส่งออก"); return; }
            
            const rows = orders.map(o => ({
                'Order No': o.orderNo,
                'Date': o.createdAt.toDate().toLocaleDateString('th-TH'),
                'Customer': o.userName,
                'Items': o.items.map(i => `${i.name} (x${i.qty})`).join(', '),
                'Total Price': o.total,
                'Status': o.status,
                'Tracking': o.trackingNumber || '-'
            }));

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Orders");
            XLSX.writeFile(wb, `FurniturePro_Sales_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        window.renderAdminProducts = () => {
            const tbody = el('admin-product-table');
            tbody.innerHTML = '';
            if(products.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">ไม่มีสินค้า</td></tr>'; return; }
            products.forEach(p => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4"><img src="${p.imageUrl}" class="w-12 h-12 rounded object-cover bg-slate-200"></td>
                        <td class="p-4 font-medium text-slate-700">${p.name}</td>
                        <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${p.category}</span></td>
                        <td class="p-4 font-bold text-indigo-600">${p.stock || 0} ชิ้น</td>
                        <td class="p-4 font-bold text-slate-700">${formatMoney(p.price)}</td>
                        <td class="p-4 text-right">
                            <button onclick="openProductModal('${p.id}')" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded transition"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition ml-1"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }

        window.openProductModal = (id = null) => {
            el('product-modal').classList.remove('hidden');
            if (id) {
                const p = products.find(x => x.id === id);
                el('modal-title').innerText = "แก้ไขสินค้า";
                el('edit-id').value = p.id;
                el('edit-name').value = p.name;
                el('edit-cat').value = p.category;
                el('edit-stock').value = p.stock || 0;
                el('edit-price').value = p.price;
                el('edit-img-url').value = p.imageUrl;
            } else {
                el('modal-title').innerText = "เพิ่มสินค้าใหม่";
                document.querySelector('#product-modal form').reset();
                el('edit-id').value = '';
                el('edit-stock').value = 0;
            }
        }

        window.saveProduct = async (e) => {
            e.preventDefault();
            showLoading(true);
            const id = el('edit-id').value;
            const name = el('edit-name').value;
            const cat = el('edit-cat').value;
            const stock = Number(el('edit-stock').value);
            const price = Number(el('edit-price').value);
            const urlInput = el('edit-img-url').value;
            const fileInput = el('edit-file').files[0];

            try {
                let finalUrl = urlInput || "https://via.placeholder.com/150";
                if (fileInput) finalUrl = await compressImage(fileInput);
                const data = { name, category: cat, price, stock, imageUrl: finalUrl };

                if (id) await updateDoc(doc(db, "products", id), data);
                else await addDoc(collection(db, "products"), { ...data, createdAt: new Date() });
                
                el('product-modal').classList.add('hidden');
                await fetchProducts(); 
                renderAdminProducts();
                filterProducts('all'); 
                alert("✅ บันทึกสำเร็จ");
            } catch (err) { console.error(err); alert("บันทึกไม่สำเร็จ: " + err.message); } finally { showLoading(false); }
        }

        window.deleteProduct = async (id) => { if(confirm("ลบ?")) { showLoading(true); await deleteDoc(doc(db, "products", id)); await fetchProducts(); renderAdminProducts(); filterProducts('all'); showLoading(false); } }

        const fetchAdminOrders = () => {
            const q = query(collection(db, "orders")); 
            onSnapshot(q, (snap) => {
                orders = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.createdAt - a.createdAt);
                filterAdminOrders('all');
                calculateDashboardStats();
            });
        }

        window.filterAdminOrders = (statusFilter) => {
            const list = el('admin-order-list');
            list.innerHTML = '';
            const filtered = statusFilter === 'all' ? orders : orders.filter(o => o.status === statusFilter);
            filtered.forEach(o => {
                let optionsHtml = '';
                Object.keys(STATUS_MAP).forEach(key => {
                    const selected = o.status === key ? 'selected' : '';
                    optionsHtml += `<option value="${key}" ${selected}>${STATUS_MAP[key].label}</option>`;
                });
                const currentTrack = o.trackingNumber || '';
                list.innerHTML += `
                    <div class="bg-white p-5 rounded-xl border shadow-sm flex flex-col md:flex-row gap-4 items-start md:items-center">
                        <div class="relative group cursor-pointer flex-shrink-0" onclick="openSlip('${o.slipUrl}')">
                            <img src="${o.slipUrl}" class="w-20 h-20 object-cover rounded-lg bg-slate-200 border">
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 rounded-lg transition text-xs">ดูสลิป</div>
                        </div>
                        <div class="flex-grow min-w-[200px]">
                            <div class="flex items-center gap-2">
                                <div class="font-bold text-slate-800">#${o.orderNo}</div>
                                <button onclick="openOrderDetail('${o.id}')" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200"><i class="fas fa-search-plus"></i> ดูรายละเอียด</button>
                            </div>
                            <div class="text-sm text-slate-500 mb-1"><i class="fas fa-user"></i> ${o.userName}</div>
                            <div class="text-lg font-bold text-indigo-600">${formatMoney(o.total)}</div>
                            <div class="text-xs text-slate-400 mt-1 truncate w-full max-w-[250px]"><i class="fas fa-map-marker-alt"></i> ${o.address}</div>
                        </div>
                        <div class="w-full md:w-auto bg-slate-50 p-3 rounded-lg border border-slate-200 flex flex-col gap-2">
                            <div class="text-xs font-bold text-slate-500 uppercase">จัดการสถานะ</div>
                            <select id="status-select-${o.id}" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">${optionsHtml}</select>
                            <input type="text" id="track-input-${o.id}" value="${currentTrack}" placeholder="เลขพัสดุ (ถ้ามี)" class="w-full border border-slate-300 rounded px-2 py-1.5 text-sm focus:outline-none focus:border-indigo-500 font-mono">
                            <button onclick="saveOrderUpdate('${o.id}')" class="w-full bg-indigo-600 text-white text-sm font-bold py-1.5 rounded hover:bg-indigo-700 transition shadow-sm">บันทึกการแก้ไข</button>
                        </div>
                    </div>`;
            });
        }

        window.openOrderDetail = (orderId) => {
            const o = orders.find(x => x.id === orderId);
            if(!o) return;
            let itemsHtml = '';
            o.items.forEach(i => {
                itemsHtml += `<div class="flex justify-between py-2 border-b last:border-0"><div><span class="font-bold text-slate-700">${i.name}</span> <span class="text-xs text-slate-500">x${i.qty}</span></div><div class="font-mono text-slate-600">${formatMoney(i.price * i.qty)}</div></div>`;
            });
            const date = o.createdAt.toDate().toLocaleString('th-TH');
            const statusLabel = STATUS_MAP[o.status].label;
            el('order-detail-content').innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <div class="bg-slate-50 p-4 rounded-xl mb-4"><h4 class="font-bold text-slate-700 mb-2">ข้อมูลลูกค้า</h4><p class="text-sm text-slate-600"><i class="fas fa-user w-5"></i> ${o.userName}</p><p class="text-sm text-slate-600"><i class="fas fa-clock w-5"></i> ${date}</p><p class="text-sm text-slate-600 mt-2"><i class="fas fa-map-marker-alt w-5"></i> ${o.address}</p></div>
                        <div class="border rounded-xl p-4"><h4 class="font-bold text-slate-700 mb-2">รายการสินค้า</h4>${itemsHtml}<div class="flex justify-between mt-4 pt-4 border-t font-bold text-lg"><span>ยอดรวมสุทธิ</span><span class="text-indigo-600">${formatMoney(o.total)}</span></div></div>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-700 mb-2">หลักฐานการโอนเงิน</h4>
                        <div class="rounded-xl overflow-hidden border shadow-sm cursor-pointer hover:opacity-90 transition" onclick="openSlip('${o.slipUrl}')"><img src="${o.slipUrl}" class="w-full h-64 object-cover bg-slate-100"></div>
                        <div class="mt-4 p-3 bg-indigo-50 border border-indigo-100 rounded text-center text-indigo-800 text-sm font-bold">สถานะปัจจุบัน: ${statusLabel}</div>
                    </div>
                </div>`;
            el('order-detail-modal').classList.remove('hidden');
        }

        window.saveOrderUpdate = async (orderId) => {
            const newStatus = document.getElementById(`status-select-${orderId}`).value;
            const newTrack = document.getElementById(`track-input-${orderId}`).value.trim();
            if(!confirm(`ต้องการอัปเดตเป็นสถานะ "${STATUS_MAP[newStatus].label}" หรือไม่?`)) return;
            showLoading(true);
            try {
                await updateDoc(doc(db, "orders", orderId), { status: newStatus, trackingNumber: newTrack });
                alert("✅ อัปเดตข้อมูลเรียบร้อย");
            } catch (err) { console.error(err); alert("เกิดข้อผิดพลาด: " + err.message); } finally { showLoading(false); }
        }

        window.onload = async () => { await init(); };

        // --- Chatbot ---
        const GEMINI_API_KEY = "AIzaSyCssrRImDqzhPTi3bujvPnUCRCS9AWQpEE"; 
        const chatWindow = el('chat-window');
        const chatMessages = el('chat-messages');
        const chatInput = el('chat-input');
        const btnSend = el('btn-send');

        window.toggleChat = () => {
            chatWindow.classList.toggle('hidden');
            if(!chatWindow.classList.contains('hidden')) { setTimeout(() => chatInput.focus(), 100); scrollToBottom(); }
        }

        function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }

        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in-up`;
            const bubble = document.createElement('div');
            bubble.className = sender === 'user' ? 'bg-indigo-600 text-white px-4 py-2.5 rounded-2xl rounded-tr-none text-sm shadow-md max-w-[85%]' : 'bg-white border border-slate-200 text-slate-700 px-4 py-2.5 rounded-2xl rounded-tl-none text-sm shadow-sm max-w-[85%] leading-relaxed';
            bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-indigo-700">$1</span>').replace(/\n/g, '<br>');
            div.appendChild(bubble);
            chatMessages.appendChild(div);
            scrollToBottom();
        }

        window.sendQuick = (text) => { chatInput.value = text; sendChatMessage({ preventDefault: () => {} }); }

        window.sendChatMessage = async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;
            appendMessage(text, 'user');
            chatInput.value = '';
            btnSend.disabled = true;
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `<div class="bg-white border border-slate-100 px-4 py-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-2"><span class="text-xs text-slate-400">กำลังพิมพ์...</span></div>`;
            chatMessages.appendChild(loadingDiv);
            scrollToBottom();

            try {
                let productContext = "";
                if(window.products && window.products.length > 0) {
                    productContext = "รายการสินค้าที่มี:\n";
                    window.products.forEach(p => {
                        const stockStatus = (p.stock > 0) ? `มีของ (${p.stock})` : "สินค้าหมด";
                        productContext += `- ${p.name}: ราคา ${p.price} บาท (${p.category}) [${stockStatus}]\n`;
                    });
                } else { productContext = "ไม่มีสินค้าในร้าน"; }
                const systemPrompt = `บทบาท: คุณคือ "น้องเฟอร์นิ" AI ผู้ช่วยขายของร้าน Furniture Pro\nข้อมูลร้านค้า: ธนาคาร กสิกรไทย 012-3-45678-9\n${productContext}\nคำสั่ง: ตอบคำถามลูกค้าสุภาพ`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: systemPrompt + `\nลูกค้าถาม: ${text}` }] }] })
                });
                const data = await response.json();
                document.getElementById(loadingId).remove();
                if (data.candidates && data.candidates.length > 0) appendMessage(data.candidates[0].content.parts[0].text, 'ai');
                else appendMessage("ไม่เข้าใจคำถาม", 'error');
            } catch (err) { document.getElementById(loadingId)?.remove(); appendMessage("⚠️ เชื่อมต่อไม่ได้", 'error'); } 
            finally { btnSend.disabled = false; setTimeout(() => chatInput.focus(), 100); }
        }
    </script>

    <button onclick="toggleChat()" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl hover:bg-indigo-700 transition-all z-[90] hover:scale-110 group">
        <i class="fas fa-comment-dots group-hover:animate-bounce"></i>
        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse">AI</span>
    </button>

    <div id="chat-window" class="fixed bottom-24 right-6 w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-100 z-[90] hidden flex flex-col overflow-hidden transition-all transform origin-bottom-right" style="height: 500px; max-height: 80vh;">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-4 text-white flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/30"><i class="fas fa-robot text-lg"></i></div>
                <div><h3 class="font-bold text-sm">น้องเฟอร์นิ (AI)</h3><p class="text-[10px] text-indigo-100 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span> พร้อมตอบคำถาม</p></div>
            </div>
            <button onclick="toggleChat()" class="text-indigo-100 hover:text-white hover:bg-white/10 p-1 rounded transition"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto bg-slate-50 space-y-4 scroll-smooth">
            <div class="flex justify-start"><div class="bg-white border border-slate-200 text-slate-700 px-4 py-3 rounded-2xl rounded-tl-none text-sm shadow-sm max-w-[90%]">สวัสดีครับ! 👋 น้องเฟอร์นิยินดีให้บริการครับ สอบถามสินค้าหรือราคาได้เลย!</div></div>
        </div>
        <div class="px-4 py-2 bg-slate-50 flex gap-2 overflow-x-auto no-scrollbar border-t border-slate-100">
            <button onclick="sendQuick('แนะนำสินค้าขายดี')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 text-xs rounded-full hover:bg-indigo-50 transition shadow-sm">🔥 สินค้าแนะนำ</button>
            <button onclick="sendQuick('ขอเลขบัญชีหน่อย')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 text-xs rounded-full hover:bg-indigo-50 transition shadow-sm">💳 เลขบัญชี</button>
            <button onclick="sendQuick('มีโปรโมชั่นไหม')" class="whitespace-nowrap px-3 py-1.5 bg-white border border-indigo-200 text-indigo-600 text-xs rounded-full hover:bg-indigo-50 transition shadow-sm">🏷️ โปรโมชั่น</button>
        </div>
        <div class="p-3 bg-white border-t border-slate-100">
            <form onsubmit="sendChatMessage(event)" class="flex gap-2">
                <input type="text" id="chat-input" class="flex-grow border border-slate-200 bg-slate-50 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500 focus:bg-white transition" placeholder="พิมพ์คำถาม..." autocomplete="off">
                <button type="submit" id="btn-send" class="bg-indigo-600 text-white w-10 h-10 rounded-full hover:bg-indigo-700 flex-shrink-0 shadow-md flex items-center justify-center transition transform hover:scale-105"><i class="fas fa-paper-plane text-xs"></i></button>
            </form>
            <div class="text-[10px] text-center text-slate-300 mt-1.5">Powered by Gemini AI</div>
        </div>
    </div>

</body>
</html>